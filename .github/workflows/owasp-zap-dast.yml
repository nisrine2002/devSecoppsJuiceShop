name: "OWASP ZAP DAST Scan"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap-scan:
    name: OWASP ZAP Dynamic Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm install
        echo "‚úÖ Dependencies installed"

    - name: Start Juice Shop in background
      run: |
        echo "üöÄ Starting Juice Shop..."
        npm start > juice-shop.log 2>&1 &
        echo $! > juice-shop.pid
        echo "‚è≥ Waiting 2 minutes for application to start..."
        sleep 120

    - name: Verify application is running
      run: |
        echo "üîç Verifying application is accessible..."
        for i in {1..30}; do
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "‚úÖ Application is ready!"
            exit 0
          fi
          echo "‚è≥ Waiting... attempt $i/30"
          sleep 5
        done
        echo "‚ùå Application failed to start"
        cat juice-shop.log
        exit 1

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: 'http://localhost:3000'
        allow_issue_writing: false
        fail_action: false

    - name: Upload ZAP HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-html-report
        path: report_html.html
        if-no-files-found: warn

    - name: Upload ZAP JSON Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-json-report
        path: report_json.json
        if-no-files-found: warn

    - name: Upload ZAP Markdown Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-markdown-report
        path: report_md.md
        if-no-files-found: warn

    - name: Upload All ZAP Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-all-reports
        path: |
          report_html.html
          report_json.json
          report_md.md
        if-no-files-found: warn

    - name: Upload application logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: application-logs
        path: juice-shop.log

    - name: Stop Juice Shop
      if: always()
      run: |
        echo "üõë Stopping application..."
        if [ -f juice-shop.pid ]; then
          kill $(cat juice-shop.pid) || true
          rm juice-shop.pid
        fi
        pkill -f "npm start" || true
        pkill -f "node" || true