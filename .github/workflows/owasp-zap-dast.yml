name: "OWASP ZAP DAST Scan"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap-scan:
    name: OWASP ZAP Dynamic Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm install
        echo "âœ… Dependencies installed"

    - name: Start Juice Shop application
      run: |
        echo "ðŸš€ Starting Juice Shop..."
        nohup npm start > juice-shop.log 2>&1 &
        echo $! > juice-shop.pid
        echo "Application PID: $(cat juice-shop.pid)"
        echo "â³ Waiting 2 minutes for application to fully start..."
        sleep 120

    - name: Verify application is running
      run: |
        echo "ðŸ” Checking if application is responding..."
        for i in {1..30}; do
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Application is ready on http://localhost:3000"
            curl -I http://localhost:3000
            exit 0
          fi
          echo "â³ Attempt $i/30 - waiting 10 seconds..."
          sleep 10
        done
        echo "âŒ Application failed to start"
        echo "ðŸ“„ Application logs:"
        cat juice-shop.log || echo "No logs available"
        exit 1

    - name: Run OWASP ZAP Baseline Scan
      continue-on-error: true
      run: |
        echo "ðŸ” Starting ZAP scan..."
        docker pull ghcr.io/zaproxy/zaproxy:stable
        docker run --network="host" -v $(pwd):/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable \
          zap-baseline.py -t http://localhost:3000 \
          -r zap-report.html \
          -x zap-report.xml \
          -J zap-report.json || echo "ZAP scan completed with findings"

    - name: Check generated reports
      if: always()
      run: |
        echo "ðŸ“Š Checking for generated reports..."
        ls -la zap-report.* 2>/dev/null || echo "Checking reports..."
        if [ -f zap-report.html ]; then 
          echo "âœ… HTML report found"
          ls -lh zap-report.html
        fi
        if [ -f zap-report.xml ]; then 
          echo "âœ… XML report found"
          ls -lh zap-report.xml
        fi
        if [ -f zap-report.json ]; then 
          echo "âœ… JSON report found"
          ls -lh zap-report.json
        fi

    - name: Upload ZAP HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-html-report
        path: zap-report.html
        if-no-files-found: warn

    - name: Upload ZAP XML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-xml-report
        path: zap-report.xml
        if-no-files-found: warn

    - name: Upload ZAP JSON Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-json-report
        path: zap-report.json
        if-no-files-found: warn

    - name: Upload All ZAP Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zap-all-reports
        path: zap-report.*
        if-no-files-found: warn

    - name: Upload application logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: application-logs
        path: juice-shop.log
        if-no-files-found: warn

    - name: Stop Juice Shop
      if: always()
      run: |
        echo "ðŸ›‘ Stopping application..."
        if [ -f juice-shop.pid ]; then
          kill $(cat juice-shop.pid) || true
          rm juice-shop.pid
        fi
        pkill -f "npm start" || true
        pkill -f "node" || true
        echo "âœ… Cleanup completed"